{"version":3,"file":"model.hits.model.js","sourceRoot":"","sources":["../../../src/modules/model-hits/model.hits.model.ts"],"names":[],"mappings":"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","sourcesContent":["import { UserModel } from './../user/user.model';\nimport { AppModel } from './../app/app.model';\nimport { model, Model, type, io, query, validate, ObjectId  } from '../../';\nimport { Request, Response } from 'express';\nimport moment from 'moment';\nlet debug = require('debug')('app:models:models.hits.model');\n\nexport class Hit {\n  method: 'get' | 'post' | 'put' | 'delete';\n  date: Date;\n}\n\n@model('modelhits')\nexport class ModelHitsModel extends Model {\n  @type.model({model: AppModel})\n  @io.toDocument\n  @query.filterable({type: 'auto'})\n  @validate.required\n  public appId: ObjectId | null = null;\n\n  @type.model({model: UserModel})\n  @io.toDocument\n  @query.filterable({type: 'auto'})\n  @validate.required\n  public userId: ObjectId | null = null;\n\n  @type.string\n  @io.toDocument\n  @validate.required\n  modelId: string = '';\n\n  @type.any\n  @io.toDocument\n  @validate.required\n  elementId: ObjectId;\n\n  @type.boolean\n  @io.toDocument\n  singleHit: boolean = true;\n\n  @type.string\n  @io.toDocument\n  @validate.required\n  ip: string = '';\n\n  @type.array({type: 'object', options: {\n    keys: {\n      method: {type: 'select', options: ['get', 'post', 'put', 'delete'], required: true},\n      date: {type: 'date', required: true}\n    }\n  }})\n  @io.toDocument\n  @validate.required\n  hits: Array<Hit> = [];\n\n  static singleHit(req: Request, res: Response, modelId: string, elementId?: string) {\n    if (!res || !res.locals || !res.locals.app) throw new Error('Missing app in res.locals');\n    let appId = res.locals.app._id;\n    let userId = (res.locals.user) ? res.locals.user._id : undefined;\n    let elId = ModelHitsModel.elementIdFromRequest(req, res, elementId);\n    if (!req.ip) throw new Error('Missing IP');\n    let ip = req.ip;\n    let method = req.method;\n    let date = moment().toDate();\n\n\n    let findQuery = {\n      appId: appId,\n      userId: userId,\n      modelId: modelId,\n      elementId: elId,\n      ip: ip,\n      singleHit: true,\n      \"hits.date\": {$gte: moment().startOf('day').toDate()}\n    };\n\n    let upsertQuery = {\n      $set: {\n        appId: appId,\n        userId: userId,\n        modelId: modelId,\n        elementId: elId,\n        ip: ip,\n        singleHit: true\n      },\n      $push: {\n        \"hits\": {\n          method: method,\n          date: date\n        }\n      }\n    };\n\n    return ModelHitsModel.deco.db.collection(ModelHitsModel.deco.collectionName).update(findQuery, upsertQuery, {upsert: true});\n\n  }\n\n  static singleStats(req: Request, res: Response, modelId: string, elementId?: string) {\n    if (!res || !res.locals || !res.locals.app) throw new Error('Missing app in res.locals');\n    let appId = res.locals.app._id;\n    let elId = ModelHitsModel.elementIdFromRequest(req, res, elementId);\n    let findQuery = {appId: appId, modelId: modelId, elementId: elId};\n    return ModelHitsModel.deco.db.collection(ModelHitsModel.deco.collectionName).find(findQuery).count();\n  }\n\n\n  static elementIdFromRequest(req: Request, res: Response, elementId?: string): ObjectId {\n    if (!elementId) {\n      if (req.params.elementId) elementId = req.params.elementId;\n      else if (res.locals.element && res.locals.element._id) elementId = res.locals.element._id.toString();\n      else if (res.locals.element && res.locals.element.id) elementId = res.locals.element.id;\n      if (!elementId) throw new Error('Missing elementId');\n    }\n\n    let response: ObjectId;\n    try {\n      response = new ObjectId(elementId);\n    } catch(error) {\n      throw new Error('Invalid elementId');\n    }\n\n    return response;\n  }\n}"]}