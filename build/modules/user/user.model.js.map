{"version":3,"file":"user.model.js","sourceRoot":"","sources":["../../../src/modules/user/user.model.ts"],"names":[],"mappings":"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","sourcesContent":["import { AppModel } from './../app/app.model';\nimport { Policies, model, Model, type, io, query, validate, ObjectId, Settings, Query, UpdateQuery, mongo } from '../../';\nimport crypto from 'crypto';\nimport moment from 'moment';\nconst hmacsha1 = require('crypto-js/hmac-sha1');\n// import hmacsha1 from 'crypto-js/hmac-sha1';\nlet debug = require('debug')('app:models:user');\n\n@Policies.modelPolicy('getAll', {public: false, userIdByProperty: '_createdBy'})\n@Policies.modelPolicy('getOne', {public: false, userIdByProperty: '_createdBy'})\n@Policies.modelPolicy('put', {public: false, userIdByProperty: '_createdBy'})\n@model('users')\nexport class UserModel extends Model {\n\n  @type.model({model: AppModel})\n  @io.all\n  @query.filterable({type: 'auto'})\n  @validate.required\n  @mongo.index({type: 'single'})\n  public appId: ObjectId | null = null;\n\n  @type.string\n  @io.all\n  @validate.required\n  @query.searchable\n  @query.all\n  public firstname: string = '';\n\n  @type.string\n  @io.all\n  @validate.required\n  @query.searchable\n  @query.all\n  public lastname: string = '';\n\n  @type.string\n  @io.all\n  @validate.email\n  @query.searchable\n  @query.all\n  @validate.uniqueByApp\n  @mongo.index({type: 'single'})\n  public email: string = '';\n\n  @type.boolean\n  @io.toDocument\n  @io.output\n  @validate.required\n  public emailValidated: boolean = false;\n\n  @type.string\n  @io.all\n  @query.all\n  @query.searchable\n  @validate.uniqueByApp\n  @mongo.index({type: 'single'})\n  public mobile: string = '';\n\n  @type.boolean\n  @io.toDocument\n  @io.output\n  @validate.required\n  public mobileValidated: boolean = false;\n\n  @type.string\n  @io.toDocument\n  @validate.required\n  @query.all\n  @mongo.index({type: 'single'})\n  public hash: string = '';\n\n  @type.date\n  @io.toDocument\n  @validate.required\n  public hashUpdateDate: Date = new Date();\n\n  @type.boolean\n  @io.all\n  requireDoubleAuth: boolean = false;\n\n  @type.string\n  @io.all\n  public locale: string;\n\n  @type.array({type: 'string'})\n  @io.input\n  @io.output\n  @io.toDocument\n  roles: Array<string> = [];\n\n  @type.boolean\n  @io.output\n  @io.toDocument\n  hideOnboarding: boolean = false;\n\n  static hashFromPassword(password: string) {\n    return crypto.createHmac('sha1', Settings.cryptoKey).update(password).digest('hex');\n  }\n\n  generateHash(password: string) {\n    this.hash = UserModel.hashFromPassword(password);\n    this.hashUpdateDate = moment().toDate();\n  }\n\n  toDocument(operation: 'insert' | 'update' | 'upsert', properties: Array<string> = []): Promise<UpdateQuery> {\n    if (this.email) this.email = this.email.toLowerCase();\n    return super.toDocument(operation, properties)\n  }\n\n  static authUser(appId: ObjectId, username: string, password: string): Promise<UserModel | false> {\n    let query = new Query({appId: appId});\n    username = username.toLowerCase().trim();\n    query.addQuery({$or: [\n      {email: username},\n      {mobile: username}\n    ]});\n\n    query.addQuery({hash: UserModel.hashFromPassword(password.trim())});\n\n    return UserModel.getOneWithQuery(query.onlyQuery()).then((user) => {\n      if (!user) return false;\n      return user;\n    });\n  }\n\n}\n\n// the following lines fixes the AppModel config of the appId property of the UserModel.\n// this is necessary because there is a circular reference between AppModel and UserModel\n// and the decorating concept fails to link the two correctly\nsetTimeout(() => {\n  UserModel.deco.propertyTypesOptions.appId.model = AppModel;\n}, 1000);"]}