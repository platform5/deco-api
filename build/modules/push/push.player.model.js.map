{"version":3,"file":"push.player.model.js","sourceRoot":"","sources":["../../../src/modules/push/push.player.model.ts"],"names":[],"mappings":";;;;;;;;;AAAA,qDAAiD;AACjD,kDAA8C;AAC9C,8BAAmG;AACnG,IAAI,KAAK,GAAG,OAAO,CAAC,OAAO,CAAC,CAAC,iBAAiB,CAAC,CAAC;AAQhD,IAAa,eAAe,uBAA5B,MAAa,eAAgB,SAAQ,SAAK;IA6CxC;QACE,KAAK,EAAE,CAAC;QAjCH,WAAM,GAAqB,IAAI,CAAC;QA0BhC,SAAI,GAAkB,EAAE,CAAC;QAIzB,WAAM,GAAY,IAAI,CAAC;QAI5B,IAAI,CAAC,KAAK,GAAG,iBAAe,CAAC;IAC/B,CAAC;IAED,MAAM,CAAC,SAAS,CAAC,KAAe;QAC9B,OAAO,OAAO,CAAC,GAAG,CAAC;YACjB,iBAAe,CAAC,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,iBAAe,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC,IAAI,CAAC,EAAC,KAAK,EAAE,KAAK,EAAE,MAAM,EAAE,IAAI,EAAC,CAAC,CAAC,KAAK,EAAE;YAClH,iBAAe,CAAC,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,iBAAe,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC,IAAI,CAAC,EAAC,KAAK,EAAE,KAAK,EAAE,MAAM,EAAE,KAAK,EAAC,CAAC,CAAC,KAAK,EAAE;SACpH,CAAC,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE,EAAE;YACjB,OAAO;gBACL,EAAE,EAAE,MAAM,CAAC,CAAC,CAAC;gBACb,QAAQ,EAAE,MAAM,CAAC,CAAC,CAAC;aACpB,CAAC;QACJ,CAAC,CAAC,CAAC;IACL,CAAC;IAED,MAAM,CAAC,IAAI,CAAC,KAAe;QACzB,OAAO,iBAAe,CAAC,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,iBAAe,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC,SAAS,CAAC;YACvF,EAAE,MAAM,EAAG,EAAE,KAAK,EAAG,KAAK,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE;YAC5C,EAAE,OAAO,EAAE,OAAO,EAAE;YACpB,EAAE,MAAM,EAAE,EAAE,GAAG,EAAE,OAAO,EAAE,KAAK,EAAE,EAAE,IAAI,EAAE,CAAC,EAAE,EAAE,EAAE;SACjD,CAAC,CAAC,OAAO,EAAE,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE,EAAE;YAC3B,IAAI,IAAI,GAAoB,EAAE,CAAC;YAC/B,KAAK,IAAI,CAAC,IAAI,MAAM,EAAE;gBACpB,IAAI,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC;aACvB;YACD,OAAO,IAAI,CAAC;QACd,CAAC,CAAC,CAAC;IACL,CAAC;CAEF,CAAA;AArEC;IALC,QAAI,CAAC,KAAK,CAAC,EAAC,KAAK,EAAE,oBAAQ,EAAC,CAAC;IAC7B,MAAE,CAAC,GAAG;IACN,SAAK,CAAC,UAAU,CAAC,EAAC,IAAI,EAAE,MAAM,EAAC,CAAC;IAChC,YAAQ,CAAC,QAAQ;IACjB,SAAK,CAAC,KAAK,CAAC,EAAC,IAAI,EAAE,QAAQ,EAAC,CAAC;8CACP;AAMvB;IAJC,QAAI,CAAC,KAAK,CAAC,EAAC,KAAK,EAAE,sBAAS,EAAC,CAAC;IAC9B,MAAE,CAAC,GAAG;IACN,SAAK,CAAC,UAAU,CAAC,EAAC,IAAI,EAAE,MAAM,EAAC,CAAC;IAChC,SAAK,CAAC,KAAK,CAAC,EAAC,IAAI,EAAE,QAAQ,EAAC,CAAC;+CACS;AAMvC;IAJC,QAAI,CAAC,MAAM;IACX,MAAE,CAAC,KAAK;IACR,MAAE,CAAC,UAAU;IACb,SAAK,CAAC,KAAK,CAAC,EAAC,IAAI,EAAE,QAAQ,EAAC,CAAC;8CACT;AAKrB;IAHC,QAAI,CAAC,MAAM;IACX,MAAE,CAAC,KAAK;IACR,MAAE,CAAC,UAAU;6CACM;AAKpB;IAHC,QAAI,CAAC,MAAM,CAAC,EAAC,OAAO,EAAE,CAAC,KAAK,EAAE,KAAK,CAAC,EAAC,CAAC;IACtC,MAAE,CAAC,GAAG;IACN,SAAK,CAAC,UAAU,CAAC,EAAC,IAAI,EAAE,MAAM,EAAC,CAAC;6CACP;AAK1B;IAHC,QAAI,CAAC,IAAI;IACT,MAAE,CAAC,GAAG;IACN,SAAK,CAAC,UAAU,CAAC,EAAC,IAAI,EAAE,MAAM,EAAC,CAAC;kDACV;AAKvB;IAHC,QAAI,CAAC,KAAK,CAAC,EAAC,IAAI,EAAE,QAAQ,EAAC,CAAC;IAC5B,MAAE,CAAC,GAAG;IACN,SAAK,CAAC,UAAU,CAAC,EAAC,IAAI,EAAE,MAAM,EAAC,CAAC;6CACD;AAIhC;IAFC,QAAI,CAAC,OAAO;IACZ,MAAE,CAAC,GAAG;+CACuB;AA3CnB,eAAe;IAD3B,SAAK,CAAC,YAAY,CAAC;GACP,eAAe,CA4E3B;AA5EY,0CAAe","sourcesContent":["import { UserModel } from './../user/user.model';\nimport { AppModel } from './../app/app.model';\nimport { model, Model, type, io, query, validate, ObjectId, StringNumberMap, mongo } from '../../';\nlet debug = require('debug')('app:models:dico');\n\nexport interface NbPlayers {\n  nb: number;\n  inactive?: number;\n}\n\n@model('pushplayer')\nexport class PushPlayerModel extends Model {\n\n  @type.model({model: AppModel})\n  @io.all\n  @query.filterable({type: 'auto'})\n  @validate.required\n  @mongo.index({type: 'single'})\n  public appId: ObjectId;\n\n  @type.model({model: UserModel})\n  @io.all\n  @query.filterable({type: 'auto'})\n  @mongo.index({type: 'single'})\n  public userId?: ObjectId | null = null;\n\n  @type.string\n  @io.input\n  @io.toDocument\n  @mongo.index({type: 'single'})\n  public regId: string;\n\n  @type.string\n  @io.input\n  @io.toDocument\n  public uuid: string;\n\n  @type.select({options: ['fcm', 'apn']})\n  @io.all\n  @query.filterable({type: 'auto'})\n  public type: 'fcm' | 'apn'\n\n  @type.date\n  @io.all\n  @query.filterable({type: 'auto'})\n  public lastVisit: Date;\n\n  @type.array({type: 'string'})\n  @io.all\n  @query.filterable({type: 'auto'})\n  public tags: Array<string> = [];\n\n  @type.boolean\n  @io.all\n  public active: boolean = true;\n\n  constructor() {\n    super();\n    this.model = PushPlayerModel;\n  }\n\n  static nbPlayers(appId: ObjectId): Promise<NbPlayers> {\n    return Promise.all([\n      PushPlayerModel.deco.db.collection(PushPlayerModel.deco.collectionName).find({appId: appId, active: true}).count(),\n      PushPlayerModel.deco.db.collection(PushPlayerModel.deco.collectionName).find({appId: appId, active: false}).count()\n    ]).then((values) => {\n      return {\n        nb: values[0],\n        inactive: values[1]\n      };\n    });\n  }\n\n  static tags(appId: ObjectId): Promise<StringNumberMap> {\n    return PushPlayerModel.deco.db.collection(PushPlayerModel.deco.collectionName).aggregate([ \n      { $match : { appId : appId, active: true } },\n      { $unwind: \"$tags\" },\n      { $group: { _id: \"$tags\", count: { $sum: 1 } } }\n    ]).toArray().then((result) => {\n      let tags: StringNumberMap = {};\n      for (let r of result) {\n        tags[r._id] = r.count;\n      }\n      return tags;\n    });\n  }\n  \n}"]}