{"version":3,"file":"validate.js","sourceRoot":"","sources":["../../src/decorators/validate.ts"],"names":[],"mappings":"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","sourcesContent":["import { ValidationRules } from 'aurelia-validation';\nimport { Request } from 'express';\nimport { Model } from './model';\nlet debug = require('debug')('deco-api:decorators:validate');\n\nexport { ValidationRules };\n\nexport interface PropertyValidation {\n  type: string,\n  options: any;\n}\n\nexport function addTargetValidation(target: any, type: string, key: string | number | symbol, options = {}) {\n\n  if (!target._validations) target._validations = {};\n  if (!target._validations[key]) target._validations[key] = [];\n\n  let validation: PropertyValidation = {\n    type: type,\n    options: options\n  };\n\n  target._validations[key].push(validation);\n}\n\nexport const required = <T>(target: T, key: keyof T, descriptor?: PropertyDescriptor): void | any => {\n  if (descriptor) descriptor.writable = true;\n  addTargetValidation(target, 'required', key);\n  if (descriptor) return descriptor;\n}\n\nexport const minLength = (minLength: number = 0) => {\n  return <T>(target: T, key: keyof T, descriptor?: PropertyDescriptor): void | any => {\n    if (descriptor) descriptor.writable = true;\n    addTargetValidation(target, 'minLength', key, {minLength: minLength});\n    if (descriptor) return descriptor;\n  };\n}\n\nexport const maxLength = (maxLength: number = 0) => {\n  return <T>(target: T, key: keyof T, descriptor?: PropertyDescriptor): void | any => {\n    if (descriptor) descriptor.writable = true;\n    addTargetValidation(target, 'maxLength', key, {maxLength: maxLength});\n    if (descriptor) return descriptor;\n  };\n}\n\nexport const email = <T>(target: T, key: keyof T, descriptor?: PropertyDescriptor): void | any => {\n  if (descriptor) descriptor.writable = true;\n  addTargetValidation(target, 'email', key);\n  if (descriptor) return descriptor;\n};\n\nexport const slug = <T>(target: T, key: keyof T, descriptor?: PropertyDescriptor): void | any => {\n  if (descriptor) descriptor.writable = true;\n  addTargetValidation(target, 'slug', key);\n  if (descriptor) return descriptor;\n};\n\n\nexport const uniqueByApp = <T>(target: T, key: keyof T, descriptor?: PropertyDescriptor): void | any => {\n  if (descriptor) descriptor.writable = true;\n  addTargetValidation(target, 'uniqueByApp', key);\n  if (descriptor) return descriptor;\n}\n\nValidationRules.customRule(\n  `validate:uniqueByApp`,\n  (value: any, obj: any, options: any) => {\n    if (value === null || value === undefined || value === '') return true;\n    let query: any = {};\n    query[options.key] = value;\n    query._id = {$ne: options.instance._id};\n    if (options.instance.appId) {\n      query.appId = options.instance.appId\n    } else if (options.instance.request && options.instance.request.body) {\n      let req: Request = options.instance.request;\n      query.appId = req?.body?.appId;\n    }\n    return (options.target as typeof Model).getOneWithQuery(query).then((element) => {\n      if (element) return false;\n      return true;\n    });\n  },\n  `This \\${$propertyName} already exists`\n);"]}